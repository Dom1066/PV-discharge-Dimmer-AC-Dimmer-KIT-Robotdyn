<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <title>Pv Dimmer %NAME% - Configuration</title>
    <link href="css/all.min.css?%FS_RELEASE%" rel="stylesheet" type="text/css" />
    <script>
        setTimeout(function() {
            var script = document.createElement('script');
            script.src = 'js/all.min.js?%FS_RELEASE%';
            document.head.appendChild(script);
        }, 50); // 500ms de délai
    </script>
  </head>
  <body id="page-top">
    <!-- Page Wrapper -->
    <div id="wrapper">
      <!-- Sidebar -->
      <ul
        class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion"
        id="accordionSidebar"
      >
        <!-- Sidebar - Brand -->
        <a class="sidebar-brand d-flex align-items-center justify-content-center" href="./">
          <div class="sidebar-brand-icon rotate-n-15">
            <i class="fas fa-laugh-wink"></i>
          </div>
          <div class="sidebar-brand-text mx-3">Pv Dimmer %NAME%</div>
        </a>
        <!-- Divider -->
        <hr class="sidebar-divider my-0" />
        <!-- Nav Item - Dashboard -->
        <li class="nav-item active">
          <a class="nav-link" href="./">
            <i class="fas fa-fw fa-tachometer-alt"></i>
            <span>Dashboard</span>
            <br />
            <span id="version">%VERSION%</span><br />
            <span id="RSSI">RSSI : %RSSI% dBm</span><br />
            <span id="dimmer_name">%NAME%</span>
          </a>
        </li>
        <!-- Divider -->
        <hr class="sidebar-divider" />
        <!-- Heading -->
        <div class="sidebar-heading">Interface</div>
        <!-- Nav Item - Pages Collapse Menu -->
        <li class="nav-item">
          <a class="nav-link" href="./">
            <i class="fas fa-cog"></i>
            <span>Retour Index</span>
          </a>
        </li>
        <li class="nav-item active">
          <a class="nav-link" href="config.html">
            <i class="fas fa-book"></i>
            <span>Configuration</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="minuteur.html">
            <i class="fas fa-moon"></i>
            <span>Minuteur d'appoint</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="log.html">
            <i class="fas fa-info"></i>
            <span>Console logs</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="backup.html">
            <i class="fas fa-download"></i>
            <span>Sauvegardes</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="update">
            <i class="fas fa-download"></i>
            <span>OTA</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="reboot">
            <i class="fas fa-power-off"></i>
            <span>Reboot</span>
          </a>
        </li>
        <!-- Divider -->
        <hr class="sidebar-divider" />
        <!-- Sidebar Toggler (Sidebar) -->
        <div class="text-center d-none d-md-inline">
          <button class="rounded-circle border-0" id="sidebarToggle"></button>
        </div>
      </ul>
      <!-- End of Sidebar -->
      <!-- Content wrapper -->
      <div id="content-wrapper" class="d-flex flex-column">
        <!-- Main content -->
        <div id="content">
          <!-- Topbar -->
          <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow">
            <div class="alert alert-danger" id="alertBox">
              <span class="mr-2 d-none d-lg-inline text-gray-600"></span>
              <p role="alert" id="alertContainer"></p>
            </div>
            <!-- Sidebar Toggle (Topbar) -->
            <!-- Topbar Navbar -->
            <ul class="navbar-nav ml-auto">
              <!-- Nav Item - Search Dropdown (Visible Only XS) -->
              <li class="nav-item dropdown no-arrow d-sm-none">
                <!-- Dropdown - Messages -->
                <div
                  class="dropdown-menu dropdown-menu-right p-3 shadow animated--grow-in"
                  aria-labelledby="searchDropdown"
                ></div>
              </li>
              <!-- Nav Item - Alerts -->
              <li class="nav-item dropdown no-arrow mx-1"></li>
              <div class="topbar-divider d-none d-sm-block"></div>
            </ul>
          </nav>
          <!-- End of Topbar -->
          <!-- Page Content -->
          <div class="container-fluid">
            <!-- Page Heading -->
            <h1 class="h3 mb-2 text-gray-800">Configuration</h1>
            <p class="mb-4">
              Page de configuration de votre pv dimmer, pensez à sauvegarder votre configuration sur
              la flash après l'avoir appliquée.
            </p>
            <p class="mb-4">
              page rapide d'aide :
              <a href="https://wiki.apper-solaire.org/" target="_blank" rel="noopener"> ici </a>
            </p>
            <!-- Content Row -->
            <div class="row">
              <!-- Earnings (Monthly) Card Example -->
              <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-primary shadow h-100 py-2">
                  <div class="card-body">
                    <div class="row no-gutters align-items-center">
                      <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                          Puissance
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                          <span id="state">%STATE%</span>(&#37;) <span id="power">%POWER%</span>(W)
                        </div>
                      </div>
                      <div class="col-auto">
                        <i class="fas fa-calendar fa-2x "></i>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <!-- Earnings (Monthly) Card Example -->
              <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-info shadow h-100 py-2">
                  <div class="card-body">
                    <div class="row no-gutters align-items-center">
                      <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                          Température
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                          <span id="sigma">%SIGMA%</span>(°C)
                        </div>
                      </div>
                      <div class="col-auto">
                        <i class="fas fa-dollar-sign fa-2x "></i>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <!-- Content Row -->
            <div class="row">
              <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-primary shadow h-100 py-2">
                  <div class="card-body">
                    <div class="row no-gutters align-items-center">
                      <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                          Sauvegarder sur la flash
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                          <span id="save">
                            <a href="#">SAUVEGARDER</a>
                          </span>
                          <br />
                          <span id="savemsg"></span>
                        </div>
                      </div>
                      <div class="col-auto">
                        <i class="fas fa-download_2 fa-2x"></i>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-info shadow h-100 py-2">
                  <div class="card-body">
                    <div class="row no-gutters align-items-center">
                      <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                          Mise en route du dimmer
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                          <span><a href="#" id="ONOFF">Reading State</a></span>
                        </div>
                      </div>
                      <div class="col-auto">
                        <i class="fas fa-dollar-sign fa-2x "></i>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-6">
              <form class="user" id="formulaire" method="post" action="">
                <div class="card position-relative">
                  <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Paramètres</h6>
                    <span id="saveform"></span>
                  </div>
                  <div class="card-body">
                    <div class="col-lg-12">
                      <div class="card position-relative">
                        <div class="card-header py-3">
                          <h6 class="m-0 font-weight-bold text-primary">Plage d'utilisation</h6>
                          <span id="saveform"></span>
                        </div>
                        <div class="card-body">
                          <div class="form-group row">
                            <div class="col-sm-3">Max Temp (°C)</div>
                            <div class="col-sm-3">Trigger (&percnt;)</div>
                            <div class="col-sm-3">Min Power (&percnt;)</div>
                            <div class="col-sm-3">Max Power (&percnt;)</div>
                          </div>
                          <div class="form-group row">
                            <div class="col-sm-3">
                              <input
                                type="number"
                                step="1"
                                class="form-control form-control-user"
                                id="maxtemp"
                                placeholder="%MAXTEMP%"
                              />
                            </div>
                            <div class="col-sm-3">
                              <input
                                type="number"
                                step="1"
                                class="form-control form-control-user"
                                id="trigger"
                                placeholder="%TRIGGER%"
                              />
                            </div>
                            <div class="col-sm-3">
                              <input
                                type="number"
                                step="1"
                                class="form-control form-control-user"
                                id="minpow"
                                placeholder="%MINPOW%"
                              />
                            </div>
                            <div class="col-sm-3">
                              <input
                                type="number"
                                step="1"
                                class="form-control form-control-user"
                                id="maxpow"
                                placeholder="%MAXPOW%"
                              />
                            </div>
                          </div>
                        </div>
                      </div>
                      <br />
                      <div class="card position-relative">
                        <div class="card-header py-3">
                          <h6 class="m-0 font-weight-bold text-primary">Charges</h6>
                          <span id="saveform"></span>
                        </div>
                        <div class="card-body">
                          <div class="form-group row">
                            <div
                              class="col-sm-4"
                              data-toggle="popover"
                              title="Aide"
                              data-content="Charge branchée sur la sortie Robotdyn ou SSR 1 (GND et PWM pour le SSR + pontage pins synchro)"
                              style="cursor: help"
                            >
                              Charge 1 (W) ( dimmer )
                              <i class="fas fa-info-circle"></i>
                            </div>
                            <div
                              class="col-sm-4"
                              data-toggle="popover"
                              title="Aide"
                              data-content="Charge branchée sur la sortie Jotta ou SSR2 (pontage pins synchro)"
                              style="cursor: help"
                            >
                              Charge 2 (W) ( Jotta )
                              <i class="fas fa-info-circle"></i>
                            </div>
                            <div
                              class="col-sm-4"
                              data-toggle="popover"
                              title="Aide"
                              data-content="Charge branchée sur la sortie Relay 2 ou SSR 3 (pontage pins synchro)"
                              style="cursor: help"
                            >
                              Charge 3 (W) ( relay2 )
                              <i class="fas fa-info-circle"></i>
                            </div>
                          </div>
                          <div class="form-group row">
                            <div class="col-sm-4">
                              <input
                                type="number"
                                step="1"
                                class="form-control form-control-user"
                                id="charge1"
                                placeholder="%CHARGE1%"
                              />
                            </div>
                            <div class="col-sm-4">
                              <input
                                type="number"
                                step="1"
                                class="form-control form-control-user"
                                id="charge2"
                                placeholder="%CHARGE2%"
                              />
                            </div>
                            <div class="col-sm-4">
                              <input
                                type="number"
                                step="1"
                                class="form-control form-control-user"
                                id="charge3"
                                placeholder="%CHARGE3%"
                              />
                            </div>
                          </div>
                        </div>
                      </div>
                      <br />
                      <div class="card position-relative">
                        <div class="card-header py-3">
                          <h6 class="m-0 font-weight-bold text-primary">Child</h6>
                          <span id="saveform"></span>
                        </div>
                        <div class="card-body">
                          <div class="form-group row">
                            <div class="col-sm-4">Child Dimmer IP</div>
                            <div class="col-sm-4">Child Dimmer Mode</div>
                            <div class="col-sm-4" id="dimmer-url">
                              <!-- L'url sera ajoutée ici -->
                            </div>
                          </div>
                          <div class="form-group row">
                            <div class="col-sm-6">
                              <input
                                type="text"
                                class="form-control form-control-user"
                                id="child"
                                placeholder="%CHILD%"
                              />
                            </div>
                            <div class="col-sm-4">
                              <select id="delester" class="form-control form-control-user">
                                <option value="off">off</option>
                                <option value="delester">délester</option>
                                <option value="equal">égal</option>
                              </select>
                            </div>
                          </div>
                        </div>
                      </div>
                      <br />
                      <div class="card position-relative">
                        <div class="card-header py-3">
                          <h6 class="m-0 font-weight-bold text-primary">Hostname</h6>
                          <span id="saveform"></span>
                        </div>
                        <div class="card-body">
                          <div class="form-group row">
                            <div class="col-sm-6">Dimmer Name</div>
                            <div class="col-sm-4" id="dimmer-mDNS">
                              <!-- Le nom mDNS sera rajouté ici-->
                            </div>
                          </div>
                          <div class="form-group row">
                            <div class="col-sm-6">
                              <input
                                type="text"
                                class="form-control form-control-user"
                                id="dimmername"
                                placeholder="%DIMMERNAME%"
                              />
                            </div>
                          </div>
                        </div>
                      </div>
                      <br />
                      <br />
                      <div class="card position-relative" id="DALLAS-LOCAL">
                        <div class="card-header py-3">
                          <h6 class="m-0 font-weight-bold text-primary">Dallas Local</h6>
                          <span id="saveform"></span>
                        </div>
                        <div class="card-body">
                          <div class="form-group row">
                            <div class="col-sm-6">
                              Adresse sonde DALLAS maitre
                              <br /><br />
                              <b>Sonde présentes: </b>
                              <span id="dallas"></span>
                            </div>
                            <div class="col-sm-6">
                              <input
                                type="text"
                                class="form-control form-control-user"
                                id="DALLAS"
                                placeholder="%DALLAS%"
                              />
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    <!--  fin du formumaire et envoie -->
                    <input
                      type="submit"
                      value=" Application des paramètres"
                      class="btn btn-primary btn-user btn-block"
                    />
                    <hr />
                  </div>
                  <hr />
                </div>
              </form>
            </div>
          </div>
          <!-- End of Page Content -->
        </div>
        <!-- End of Main Content -->
      </div>
      <!-- End of Content wrapper -->
    </div>
    <!-- Footer -->
    <footer class="sticky-footer bg-white">
      <div class="container my-auto">
        <div class="copyright text-center my-auto">
          <span>https://github.com/xlyric/ - 2025</span>
        </div>
      </div>
    </footer>
    <!-- End of Footer -->
    <script type="text/javascript">
      $('[data-toggle="popover"]').popover();
      //<!-- rafraichissement valeurs -->
      function refreshvalue() {
        $.getJSON("/state", function (data) {
          // Récupérer les données du JSON
          var dimmer = data.dimmer;
          var temperature = data.temperature;
          var power = data.power;
          var onoff = data.onoff;
          document.getElementById("state").innerHTML = dimmer;
          document.getElementById("sigma").innerHTML = temperature;
          document.getElementById("power").innerHTML = power;
          onoff = onoff ? "ON" : "OFF";
          $("#ONOFF").text(onoff);
          if (data.alerte && data.alerte.trim() != "") {
            const alertContainer = document.getElementById("alertContainer");
            alertContainer.textContent = "Alerte : " + data.alerte;
            $("#alertBox").fadeIn();
          } else {
            $("#alertBox").fadeOut();
          }
                   // affichage des dallas et les Température ( boucle sur les dallas )
          var dallasData = {}; // Objet pour stocker les données des capteurs Dallas
          var dallasNumber;
          // Extraction des données des capteurs Dallas du JSON
          for (var key in data) {
            if (key.startsWith("dallas")) {
              dallasNumber = key.substring(6); // Récupérer le numéro du capteur Dallas
              var dallasTemperature = data[key];
              var dallasAddressKey = "addr" + dallasNumber;
              var dallasAddress = data[dallasAddressKey];
              dallasData[dallasNumber] = {
                temperature: dallasTemperature,
                address: dallasAddress,
              };
            }
          }
          // Affichage des données des capteurs Dallas dans la page HTML
          var dallasHtml = "";
          for (dallasNumber in dallasData) {
            dallasHtml +=
              "<p>Dallas sensor " +
              dallasNumber +
              ": " +
              dallasData[dallasNumber].temperature +
              "°C <br>Address: " +
              dallasData[dallasNumber].address +
              "</p>";
          }
          document.getElementById("dallas").innerHTML = dallasHtml;
        });
      }
      // Lancer après 500ms pour laisser l'ESP8266 charger
        setTimeout(refreshvalue, 500);
      // Puis, continuer toutes les 5 secondes
        setInterval(refreshvalue, 5000); // Rafraîchir les données toutes les 5 secondes
      function sendmode(mode) {
        $.get("/get", { send: mode }).done(function (data) {
          document.getElementById("sendmode").innerHTML = "Request sent";
          document.getElementById("sendmode2").innerHTML = "Request sent";
        });
      }
      function save() {
        $.get("/get", { save: "yes" }).done(function (data) {});
      }
      // Sauvegarde de la configuration
      $("#save").click(function () {
        $.get("/get", { save: "yes" }).done(function (data) {
          $("#savemsg").text("Configuration sauvegardée").show().fadeOut(5000);
        });
      });
      $("#ONOFF").click(function () {
        $.get("/onoff").done(function (data) {
          // si la data est 1 alors on affiche ON sinon OFF
          if (data == 1) {
            data = "ON";
          } else {
            data = "OFF";
          }
          $("#ONOFF").text(data);
        });
      });
      $("#formulaire").submit(function () {
        var data = {
          hostname: $("#hostname").val(),
          port: $("#port").val(),
          Publish: $("#Publish").val(),
          maxtemp: $("#maxtemp").val(),
          startingpow: $("#startingpow").val(),
          minpow: $("#minpow").val(),
          maxpow: $("#maxpow").val(),
          child: $("#child").val(),
          SubscribePV: $("#SubscribePV").val(),
          SubscribeTEMP: $("#SubscribeTEMP").val(),
          mode: $("#delester").val(),
          charge1: $("#charge1").val(),
          charge2: $("#charge2").val(),
          charge3: $("#charge3").val(),
          DALLAS: $("#DALLAS").val(),
          dimmername: $("#dimmername").val(),
          trigger: $("#trigger").val(),
        };
        $.ajax({
          type: "GET",
          data: data,
          url: "get",
          success: function (retour) {
            $("#saveform").text("Configuration appliquée").show().fadeOut(5000);
          },
        });
        return false;
      });
      $(document).ready(function () {
        function generateLink(dimmerValue) {
          if (dimmerValue !== "none") {
            var dimmerURL = "http://" + dimmerValue;
            $("#dimmer-url").html(
              `<a href="${dimmerURL}" target="_blank" rel="noopener">${dimmerURL}</a>`,
            );
          }
        }
        function generateLinkName(dimmerName) {
          var formattedName = dimmerName.replace(/ /g, "-") + ".local"; // Replace spaces with hyphens and add .local
          $("#dimmer-mDNS").html(formattedName); // Update the HTML content
        }
        var recupconfig = $.getJSON("/config", function (data) {
          for (var key in data) {
            if (data.hasOwnProperty(key)) {
              var element = document.getElementById(key);
              if (element) {
                element.value = data[key];
                if (element.type === "checkbox") {
                  element.checked = data[key];
                }
              }
            }
          }
          // Une fois la requête terminée
          recupconfig.done(function () {
            // Générer le lien avec la valeur initiale
            var dimmerValue = $("#child").val();
            generateLink(dimmerValue);
            var dimmerValue = $("#dimmername").val();
            generateLinkName(dimmerValue);
          });
          $("#child").on("input", function () {
            var dimmerValue = $(this).val();
            generateLink(dimmerValue);
          });
          $("#dimmer-mDNS").on("input", function () {
            var dimmerValue = $(this).val();
            generateLinkName(dimmerValue);
          });
        });
      });
    </script>
  </body>
</html>
